<!DOCTYPE html>
<html><head lang="en"><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=33113&amp;path=livereload" data-no-instant defer></script>
	<meta charset="utf-8" />
	<meta http-equiv="X-UA-Compatible" content="IE=edge"><title>eBPF for SSL packet inspections - strange invitation</title><meta name="viewport" content="width=device-width, initial-scale=1">
	<meta name="description" content="..." />
	<meta property="og:image" content=""/>
	<meta property="og:url" content="//localhost:33113/posts/ebpf-for-packet-interceptions/">
  <meta property="og:site_name" content="strange invitation">
  <meta property="og:title" content="eBPF for SSL packet inspections">
  <meta property="og:description" content="...">
  <meta property="og:locale" content="en_us">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2024-07-07T11:30:00+03:00">
    <meta property="article:modified_time" content="2024-07-07T11:30:00+03:00">
    <meta property="article:tag" content="Ebpf">

  <meta name="twitter:card" content="summary">
  <meta name="twitter:title" content="eBPF for SSL packet inspections">
  <meta name="twitter:description" content="...">
<script src="//localhost:33113/js/feather.min.js"></script>
	
	
        <link href="//localhost:33113/css/fonts.2c2227b81b1970a03e760aa2e6121cd01f87c88586803cbb282aa224720a765f.css" rel="stylesheet">
	

	
	<link rel="stylesheet" type="text/css" media="screen" href="//localhost:33113/css/main.ac08a4c9714baa859217f92f051deb58df2938ec352b506df655005dcaf98cc0.css" />
		<link id="darkModeStyle" rel="stylesheet" type="text/css" href="//localhost:33113/css/dark.726cd11ca6eb7c4f7d48eb420354f814e5c1b94281aaf8fd0511c1319f7f78a4.css" media="(prefers-color-scheme: dark)"  />
	

	
	
		<script type="text/javascript"
		src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
		</script>
	
		
		<script type="text/x-mathjax-config">
		MathJax.Hub.Config({
			tex2jax: {
				inlineMath: [['$','$'], ['\\(','\\)']],
				displayMath: [['$$','$$'], ['\[','\]']],
				processEscapes: true,
				processEnvironments: true,
				skipTags: ['script', 'noscript', 'style', 'textarea', 'pre'],
				TeX: { equationNumbers: { autoNumber: "AMS" },
						 extensions: ["AMSmath.js", "AMSsymbols.js"] }
			}
		});
		</script>
	

	
	
		<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.15.2/dist/katex.min.css">
		<script defer src="https://cdn.jsdelivr.net/npm/katex@0.15.2/dist/katex.min.js"></script>
		<script defer src="https://cdn.jsdelivr.net/npm/katex@0.15.2/dist/contrib/auto-render.min.js" onload="renderMathInElement(document.body);"></script>
		
		
		<script>
			document.addEventListener("DOMContentLoaded", function() {
					renderMathInElement(document.body, {
							delimiters: [
									{left: "$$", right: "$$", display: true},
									{left: "$", right: "$", display: false}
							]
					});
			});
			</script>
	
	
	
</head>
<body>
        <div class="content"><header>
	<div class="main">
		<a href="//localhost:33113/">strange invitation</a>
	</div>
	<nav>
		
		<a href="/">Home</a>
		
		<a href="/posts">All posts</a>
		
		<a href="/about">About</a>
		
		<a href="/tags">Tags</a>
		
		
	</nav>
</header>

<main>
	<article>
		<div class="title">
			<h1 class="title">eBPF for SSL packet inspections</h1>
			<div class="meta">Posted on Jul 7, 2024</div>
		</div>
		

		<section class="body">
			<p>{{ .Page.TableOfContents }}</p>
<p>As a retrospection of task in a process, i&rsquo;ve had a task to intercept http
traffic sent by different processes with encryption using openssl. Main points
of that task (related to eBPF) were:</p>
<ul>
<li>eBPF uprobes for SSL_* functions (to obtain data that was sent/recived)</li>
<li>eBPF kprobes for tcp_sendmsg/tcp_recvmsg (to obtain src/dst hosts/ports)</li>
<li>a lot of tracepoints (primarily to map fd)</li>
</ul>
<h2 id="setting-development-environment">Setting development environment</h2>
<p>I&rsquo;m using WSL2 with arch on windows platform, so we&rsquo;re having env problems :D
First take was clion - but, sadly, I&rsquo;ve failed to set up make projets &gt;_&lt;</p>
<p>Second take was with vim - <code>github/copilot.vim</code>+<code>ycm-core/YouCompleteMe</code> works
just fine (except <code>.h</code> files were interpreted as <code>c++</code> files and large
<code>vmlinux.h</code> processing was exceptionally slow, freezing vim for forever).
As a possible workaround <code>vmlinux_part.h</code> was created, with a lot of parts
to be deleted. Not convenient :(</p>
<p>Third take was with Sublime as editor - <code>c lsp plugin</code> failed to use clangd
(some extended problems with host-vm :) ), but LSP-copilot works. 50/50
usability!</p>
<h2 id="file-structure">File structure</h2>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-console" data-lang="console"><span style="display:flex;"><span>$ tree
</span></span><span style="display:flex;"><span>├── TODO.md
</span></span><span style="display:flex;"><span>├── include
</span></span><span style="display:flex;"><span>│   ├── bpf_endian.h
</span></span><span style="display:flex;"><span>│   ├── bpf_helper_defs.h
</span></span><span style="display:flex;"><span>│   ├── bpf_helpers.h
</span></span><span style="display:flex;"><span>│   ├── bpf_tracing.h
</span></span><span style="display:flex;"><span>│   ├── counter.h
</span></span><span style="display:flex;"><span>│   ├── directions.h
</span></span><span style="display:flex;"><span>│   ├── helpers.h
</span></span><span style="display:flex;"><span>│   ├── logger.h
</span></span><span style="display:flex;"><span>│   ├── pid_checker.h
</span></span><span style="display:flex;"><span>│   ├── structures.h
</span></span><span style="display:flex;"><span>│   └── vmlinux.h
</span></span><span style="display:flex;"><span>├── kprobe.c
</span></span><span style="display:flex;"><span>├── makefile
</span></span><span style="display:flex;"><span>├── module.c
</span></span><span style="display:flex;"><span>├── nodemon.json
</span></span><span style="display:flex;"><span>├── openssl-args.c
</span></span><span style="display:flex;"><span>├── openssl-stats.c
</span></span><span style="display:flex;"><span>├── openssl-store.c
</span></span><span style="display:flex;"><span>├── openssl.c
</span></span><span style="display:flex;"><span>├── prepare-env.py
</span></span><span style="display:flex;"><span>└── tracepoint.c
</span></span></code></pre></div><p>so what&rsquo;s in include directories?</p>
<ul>
<li><code>vmlinux.h</code> - contains all linux kernel definitions (types, structures, enums, etc)<br>
generated using <code>bpftool btf dump file /sys/kernel/btf/vmlinux format c &gt; vmlinux.h</code></li>
<li>ebpf helpers: (<code>bpf_*.h</code> - <a href="https://github.com/libbpf/libbpf/blob/v0.6.1/src/bpf_tracing.h">https://github.com/libbpf/libbpf/blob/v0.6.1/src/bpf_tracing.h</a>)</li>
<li>self-written helpers &hellip;</li>
</ul>
<p>and what about source file structure?</p>
<ul>
<li><code>module.c</code> - main file point, all defines and includes of all functions
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#75715e">//go:build ignore
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#define PID_CHECK_STATE 0
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#define DEBUG_PRINT 1
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#define OPENSSL_VERSION 0x30300000
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&#34;openssl.c&#34;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&#34;tracepoint.c&#34;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&#34;kprobe.c&#34;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">static</span> <span style="color:#66d9ef">char</span> _license[] <span style="color:#a6e22e">SEC</span>(<span style="color:#e6db74">&#34;license&#34;</span>) <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;Dual BSD/GPL&#34;</span>;
</span></span></code></pre></div>it&rsquo;s used for convenience of building of single module using <code>bpf2go</code></li>
<li><code>tracepoint.c</code>/<code>openssl.c</code>/<code>kprobe.c</code> - files with all ebpf entrypoints.</li>
<li><code>openssl-*.c</code> files are used to store helpers.</li>
</ul>
<h2 id="ebpf-primer-for-uprobeskprobestracepoints">eBPF primer for uprobes/kprobes/tracepoints</h2>
<p>just a note: difference between <code>k(u)probe</code> and <code>k(u)retprobe</code> is a time when
callback is called. <code>*probe</code> is called on entering function and <code>*retprobe</code> is
called on function exit. Input arguments can be accessed only in <code>*probe</code>,
output argement can be accessed only in <code>*retprobe</code>.</p>
<p>Naming in <code>SEC</code> macro is vital, so &ldquo;thinkaboutitman&rdquo;!</p>
<h3 id="defining-ebpf-entrypoints-and-other-functions">defining eBPF entrypoints and other functions</h3>
<ul>
<li>for eBPF we&rsquo;re using <code>SEC()</code> macro:
<code>SEC(&quot;u[ret]probe/&lt;name&gt;&quot;)</code><br>
<code>SEC(&quot;k[ret]probe/&lt;name&gt;&quot;)</code><br>
<code>SEC(&quot;tracepoint/syscalls/sys_[enter/exit]_&lt;name&gt;&quot;)</code><br>
are examples</li>
<li>for non-ebpf functions we&rsquo;re using <code>static INLINE_FUNC</code> macro to embed
all functions (since ebpf can&rsquo;t make calls to other functions we must inline
it&rsquo;s code inside [exception are tail call which must be called explicitly])</li>
</ul>
<p>Examples:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#66d9ef">static</span> INLINE_FUNC
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">direction_t</span> <span style="color:#a6e22e">get_direction</span>(u32 fd)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/* ... */</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">SEC</span>(<span style="color:#e6db74">&#34;uprobe/SSL_read&#34;</span>)
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">int</span> <span style="color:#a6e22e">uprobe_ssl_read</span>(<span style="color:#66d9ef">struct</span> pt_regs <span style="color:#f92672">*</span>ctx)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/* ... */</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">SEC</span>(<span style="color:#e6db74">&#34;tracepoint/syscalls/sys_enter_accept4&#34;</span>)
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">void</span> <span style="color:#a6e22e">sys_enter_accept4</span>(<span style="color:#66d9ef">struct</span> sys_enter_accept4_ctx <span style="color:#f92672">*</span>ctx)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/* ... */</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h3 id="accessing-return-variables-and-call-arguments-uprobeskprobes">accessing return variables and call arguments (uprobes/kprobes)</h3>
<p>Functions call arguments are accessed using <code>PT_REGS_PARM&lt;pos&gt;</code> and <code>PT_REGS_RC</code>.
As a convience helpers we&rsquo;re using macroses <code>BPF_UPROBE(&lt;name&gt;, &lt;args...&gt;)</code>,
<code>BPF_URETPROBE(&lt;name&gt;, &lt;rv&gt;)</code>, and <code>BPF_KPROBE</code>/<code>BPF_KRETPROBE</code></p>
<p>Examples:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#a6e22e">SEC</span>(<span style="color:#e6db74">&#34;uprobe/SSL_read&#34;</span>)
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">int</span> <span style="color:#a6e22e">BPF_UPROBE</span>(uprobe_ssl_read, <span style="color:#66d9ef">void</span> <span style="color:#f92672">*</span>ssl, <span style="color:#66d9ef">void</span> <span style="color:#f92672">*</span>buffer, <span style="color:#66d9ef">int</span> num)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/* ... */</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">SEC</span>(<span style="color:#e6db74">&#34;uretprobe/SSL_read&#34;</span>)
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">int</span> <span style="color:#a6e22e">BPF_URETPROBE</span>(uretprobe_ssl_read, <span style="color:#66d9ef">int</span> rv)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/* ... */</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h3 id="defining-tracepoints">defining tracepoints</h3>
<p>Tracepoint can be different types, for example <code>syscalls</code>, <code>oom</code>, <code>tcp</code>, <code>net</code>.
But for now we&rsquo;re investigating only <code>syscalls</code>.</p>
<p>To understand arguments of tracepoint - we need to cat sys path to investigate
&ldquo;what&rsquo;s inside&rdquo;:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">struct</span> sys_common_ctx {
</span></span><span style="display:flex;"><span>	u16 common_type;
</span></span><span style="display:flex;"><span>	u8  common_flags;
</span></span><span style="display:flex;"><span>	u8  common_preempt_count;
</span></span><span style="display:flex;"><span>	s32 common_pid;
</span></span><span style="display:flex;"><span>	s32 __syscall_nr;
</span></span><span style="display:flex;"><span>};
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// cat /sys/kernel/tracing/events/syscalls/sys_enter_connect/format
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">//
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">// name: sys_enter_connect
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">// ID: 2407
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">// format:
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">//         field:unsigned short common_type;       		offset:0;       size:2; signed:0;
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">//         field:unsigned char common_flags;       		offset:2;       size:1; signed:0;
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">//         field:unsigned char common_preempt_count;    offset:3;       size:1; signed:0;
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">//         field:int common_pid;              			offset:4;       size:4; signed:1;
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">//         field:int __syscall_nr; 						offset:8;       size:4; signed:1;
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">//
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">//         field:int fd;  							 	offset:16;      size:8; signed:0;
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">//         field:struct sockaddr * uservaddr;      		offset:24;      size:8; signed:0;
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">//         field:int addrlen;      						offset:32;      size:8; signed:0;
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">//
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">//
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">struct</span> sys_enter_connect_ctx {
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">struct</span> sys_common_ctx ctx;
</span></span><span style="display:flex;"><span>	u64 				  fd;
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">struct</span> sockaddr		 <span style="color:#f92672">*</span>uservaddr;
</span></span><span style="display:flex;"><span>	u64 				  uservaddr_len;
</span></span><span style="display:flex;"><span>};
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">SEC</span>(<span style="color:#e6db74">&#34;tracepoint/&lt;type&gt;/sys_enter_connect&#34;</span>)
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">void</span> <span style="color:#a6e22e">sys_enter_connect</span>(<span style="color:#66d9ef">struct</span> sys_enter_connect_ctx <span style="color:#f92672">*</span>ctx)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/* ... */</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// cat /sys/kernel/tracing/events/syscalls/sys_exit_connect/format
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">//
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">// name: sys_exit_connect
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">// ID: 2406
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">// format:
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">//         field:unsigned short common_type;       		offset:0;       size:2; signed:0;
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">//         field:unsigned char common_flags;       		offset:2;       size:1; signed:0;
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">//         field:unsigned char common_preempt_count;    offset:3;       size:1; signed:0;
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">//         field:int common_pid;   						offset:4;       size:4; signed:1;
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">//         field:int __syscall_nr; 						offset:8;       size:4; signed:1;
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">//
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">//         field:long ret; 								offset:16;      size:8; signed:1;
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">struct</span> sys_exit_connect_ctx {
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">struct</span> sys_common_ctx ctx;
</span></span><span style="display:flex;"><span>	s64 				  ret;
</span></span><span style="display:flex;"><span>};
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">SEC</span>(<span style="color:#e6db74">&#34;tracepoint/syscalls/sys_exit_connect&#34;</span>)
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">void</span> <span style="color:#a6e22e">sys_exit_connect</span>(<span style="color:#66d9ef">struct</span> sys_exit_connect_ctx <span style="color:#f92672">*</span>ctx)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/* ... */</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h3 id="defining-and-accessing-maps">defining and accessing maps</h3>
<p>TODO</p>
<h3 id="ringbuf-as-special-type-of-map">ringbuf as special type of map</h3>
<p>TODO</p>
<h3 id="using-and-accessing-from-go-code">using and accessing from go code</h3>
<p>TODO</p>
<h2 id="ebpf-for-ssl-packet-interception-flow">eBPF for SSL packet interception flow</h2>
<p>TODO</p>
<h2 id="links">links</h2>
<ul>
<li><a href="https://cilium.isovalent.com/hubfs/Learning-eBPF%20-%20Full%20book.pdf">learning eBPF book</a></li>
<li><a href="https://github.com/cilium/ebpf">golang ebpf lib</a></li>
<li><a href="https://github.com/iovisor/bcc/blob/master/docs/kernel-versions.md">features by kernel versions</a></li>
<li><a href="https://docs.kernel.org/6.6/bpf/index.html">https://docs.kernel.org/6.6/bpf/index.html</a></li>
<li><a href="https://prototype-kernel.readthedocs.io/en/latest/bpf/index.html">https://prototype-kernel.readthedocs.io/en/latest/bpf/index.html</a></li>
</ul>

		</section>

		<div class="post-tags">
			
			
			
		</div>
		</article>
</main>
<footer>
  <div style="display:flex"><a class="soc" href="https://github.com/bigbes/bigbes" rel="me" title="GitHub"><i data-feather="github"></i></a>
    <a class="border"></a></div>
  <div class="footer-info">
    2024  bigbes |  <a
      href="https://github.com/athul/archie">Archie Theme</a> | Built with <a href="https://gohugo.io">Hugo</a>
  </div>
</footer>


  


<script>
  feather.replace()
</script></div>
    </body>
</html>
